name: Daily Script Release

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
  workflow_dispatch:
  push:
    paths:
      - 'install-ss.sh'
      - 'uninstall-ss.sh'

jobs:
  release-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: Get Release Date
        id: release-date
        run: |
          DATE=$(date +'%Y-%m-%d')
          TIMESTAMP=$(date +'%s')
          echo "RELEASE_DATE=$DATE" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=release-$DATE" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Prepare Release Assets
        run: |
          # åˆ›å»ºè„šæœ¬å‹ç¼©åŒ…
          tar -czvf scripts-${{ steps.release-date.outputs.RELEASE_DATE }}.tar.gz install-ss.sh uninstall-ss.sh
          
          # åˆ›å»ºå›ºå®šåç§°çš„å‹ç¼©åŒ…ï¼ˆæœ€æ–°ç‰ˆï¼‰
          cp scripts-${{ steps.release-date.outputs.RELEASE_DATE }}.tar.gz scripts-latest.tar.gz
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "Release Date: ${{ steps.release-date.outputs.RELEASE_DATE }}" > version.txt
          echo "Build Timestamp: ${{ steps.release-date.outputs.TIMESTAMP }}" >> version.txt
          echo "GitHub Repository: ${{ github.repository }}" >> version.txt
          echo "GitHub Run ID: ${{ github.run_id }}" >> version.txt

      - name: Create or Update Release
        uses: ncipollo/release-action@v1
        with:
          # æ¯å¤©ä½¿ç”¨å›ºå®šæ ‡ç­¾è¦†ç›–
          tag: daily-latest
          name: "Latest Scripts (${{ steps.release-date.outputs.RELEASE_DATE }})"
          body: |
             ğŸš€ æ¯æ—¥è‡ªåŠ¨æ›´æ–°çš„è„šæœ¬
            
            **åŒ…å«æ–‡ä»¶:**
            - `install-ss.sh`
            - `uninstall-ss.sh`
            
            **å‘å¸ƒæ—¥æœŸ:** ${{ steps.release-date.outputs.RELEASE_DATE }}
            **æ„å»ºæ—¶é—´:** ${{ steps.release-date.outputs.TIMESTAMP }}
            
            [æŸ¥çœ‹å·¥ä½œæµè¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          artifacts: |
            scripts-${{ steps.release-date.outputs.RELEASE_DATE }}.tar.gz
            scripts-latest.tar.gz
            version.txt
          allowUpdates: true  # å…è®¸è¦†ç›–åŒåæ ‡ç­¾
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false

      # æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
      - name: Cleanup Old Releases
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq curl
          
          # è·å–æ‰€æœ‰releaseåˆ—è¡¨
          releases=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100" | jq -r '.[] | select(.name | contains("Latest Scripts")) | [.created_at, .id, .tag_name] | @tsv' | sort -r)
          
          # ä¿ç•™æœ€æ–°5ä¸ª
          keep_count=5
          counter=0
          
          echo "$releases" | while IFS=$'\t' read -r created_at id tag; do
            counter=$((counter+1))
            if [ $counter -gt $keep_count ]; then
              echo "åˆ é™¤æ—§ç‰ˆæœ¬: $tag (ID: $id)"
              # åˆ é™¤release
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$id"
              # åˆ é™¤æ ‡ç­¾
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$tag"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“å·¥ä½œæµ
        continue-on-error: true
