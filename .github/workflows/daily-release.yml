name: Daily Script Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  release-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Scripts
        run: |
          set -e
          DATE=$(date +'%Y-%m-%d')
          echo "RELEASE_DATE=$DATE" >> $GITHUB_ENV

          FILES="install-ss.sh uninstall-ss.sh generate-ss-link.sh install-ss-docker.sh README.md README.en.md LICENSE"

          # Create archives
          tar -czf scripts-$DATE.tar.gz $FILES
          zip -q scripts-$DATE.zip $FILES

          # Latest aliases
          cp scripts-$DATE.tar.gz scripts-latest.tar.gz
          cp scripts-$DATE.zip scripts-latest.zip

          # Checksums
          sha256sum scripts-$DATE.tar.gz > scripts-$DATE.tar.gz.sha256
          sha256sum scripts-$DATE.zip > scripts-$DATE.zip.sha256
          sha256sum scripts-latest.tar.gz > scripts-latest.tar.gz.sha256
          sha256sum scripts-latest.zip > scripts-latest.zip.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: daily-latest
          name: "Latest Scripts (${{ env.RELEASE_DATE }})"
          body: "自动更新于 ${{ env.RELEASE_DATE }}"
          files: |
            scripts-${{ env.RELEASE_DATE }}.tar.gz
            scripts-${{ env.RELEASE_DATE }}.tar.gz.sha256
            scripts-${{ env.RELEASE_DATE }}.zip
            scripts-${{ env.RELEASE_DATE }}.zip.sha256
            scripts-latest.tar.gz
            scripts-latest.tar.gz.sha256
            scripts-latest.zip
            scripts-latest.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
